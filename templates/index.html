<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ hostname }} | Arog Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/alpinejs@3.13.5/dist/cdn.min.js" defer></script>
</head>
<body x-data="{ currentTab: 'dashboard' }">
    <div class="dashboard-wrapper">
        <!-- Header -->
        <div class="header">
            <h1>{{ hostname }}.dashboard</h1>
            <div class="tabs">
                <button class="tab-btn" :class="{ 'active': currentTab === 'dashboard' }" @click="currentTab = 'dashboard'">Dashboard</button>
                <button class="tab-btn" :class="{ 'active': currentTab === 'agent' }" @click="currentTab = 'agent'">Python Agent</button>
            </div>
            <div class="stats">
                <span>Uptime: {{ "%.1f"|format(system_stats.uptime / 3600) }}h</span>
                <span>Load: {{ "%.2f %.2f %.2f"|format(*system_stats.load_avg) }}</span>
                <span>Containers: {{ containers|length }}</span>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div class="tab-content" x-show="currentTab === 'dashboard'">
            <div class="main-content">

            <!-- System Info Card -->
            {% include 'fragments/system_info_card.html' %}

            <!-- Docker Containers -->
            <div class="panel">
                <div class="panel-header">
                    <span>Docker Containers ({{ containers|length }})</span>
                    <span class="text-subtle">{{ now.strftime('%H:%M:%S') }}</span>
                </div>
                <div class="panel-content">
                    <table class="container-list" id="container-table">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="state">Status</th>
                                <th>Port</th>
                                <th class="sortable" data-sort="name">Name</th>
                                <th class="sortable" data-sort="image">Image</th>
                                <th class="sortable" data-sort="created">Created</th>
                                <th class="sortable" data-sort="network">Network</th>
                                <th>Volumes</th>
                                <th class="sortable" data-sort="memory">Memory</th>
                                <th class="sortable" data-sort="cpu">CPU</th>
                                <th>Health</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for container in containers %}
                            <tr data-state="{{ container.state }}"
                                data-name="{{ container.name }}"
                                data-image="{{ container.image }}"
                                data-created="{{ container.created }}"
                                data-network="{{ container.network_mode }}"
                                data-memory="{{ container.memory_percent }}"
                                data-cpu="{{ container.cpu_percent }}">
                                <td>
                                    <span class="container-status status-{{ container.state }}"></span>
                                    <span class="{% if container.state != 'running' %}text-error{% endif %}">
                                        {{ container.state }}
                                    </span>
                                </td>
                                <td>
                                    {% if container.web_url and container.ports %}
                                        <a href="{{ container.web_url }}" target="_blank" class="port-button">
                                            {{ container.ports[0].host_port }}
                                        </a>
                                    {% elif container.ports and container.ports[0].host_port %}
                                        <span class="port-text">{{ container.ports[0].host_port }}</span>
                                    {% else %}
                                        <span class="text-subtle">-</span>
                                    {% endif %}
                                </td>
                                <td><code class="container-name">{{ container.name }}</code></td>
                                <td class="text-subtle">{{ container.image.split(':')[0].split('/')[-1] }}</td>
                                <td class="text-subtle time-ago" data-time="{{ container.created }}">
                                    {{ container.created.split('T')[0] if container.created else '-' }}
                                </td>
                                <td class="text-subtle">{{ container.network_mode }}</td>
                                <td class="text-subtle">{{ container.volumes|length }}</td>
                                <td class="{% if container.memory_percent > 80 %}text-error{% elif container.memory_percent > 60 %}text-warning{% endif %}">
                                    {% if container.memory_usage_mb > 0 %}
                                        {{ "%.0f"|format(container.memory_usage_mb) }} MB
                                        <span class="text-subtle">({{ "%.1f"|format(container.memory_percent) }}%)</span>
                                    {% else %}
                                        <span class="text-subtle">-</span>
                                    {% endif %}
                                </td>
                                <td class="{% if container.cpu_percent > 80 %}text-error{% elif container.cpu_percent > 60 %}text-warning{% endif %}">
                                    {% if container.cpu_percent > 0 %}
                                        {{ "%.1f"|format(container.cpu_percent) }}%
                                    {% else %}
                                        <span class="text-subtle">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if container.health_status %}
                                        <span class="health-badge health-{{ container.health_status }}">
                                            {{ container.health_status }}
                                        </span>
                                    {% else %}
                                        <span class="text-subtle">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- System Metrics -->
            <div class="panel">
                <div class="panel-header">
                    <span>System Metrics</span>
                    <span class="text-subtle" id="metrics-time">{{ now.strftime('%H:%M:%S') }}</span>
                </div>
                <div class="panel-content">
                    <div class="metrics-table" id="system-metrics"
                         hx-get="/api/system"
                         hx-trigger="every 2s"
                         hx-swap="innerHTML">
                        <table class="stats-table">
                            <tr>
                                <td class="stat-label">CPU</td>
                                <td class="stat-value">{{ "%.1f"|format(system_stats.cpu_percent) }}%</td>
                                <td class="stat-bar">
                                    <div class="metric-bar">
                                        <div class="metric-bar-fill {% if system_stats.cpu_percent > 80 %}error{% elif system_stats.cpu_percent > 60 %}warning{% endif %}"
                                             style="width: {{ system_stats.cpu_percent }}%"></div>
                                    </div>
                                </td>
                                <td class="stat-detail">{{ system_stats.cpu_count }} cores @ {{ "%.0f"|format(system_stats.cpu_freq or 0) }} MHz</td>
                            </tr>
                            <tr>
                                <td class="stat-label">Memory</td>
                                <td class="stat-value">{{ "%.1f"|format(system_stats.memory_percent) }}%</td>
                                <td class="stat-bar">
                                    <div class="metric-bar">
                                        <div class="metric-bar-fill {% if system_stats.memory_percent > 80 %}error{% elif system_stats.memory_percent > 60 %}warning{% endif %}"
                                             style="width: {{ system_stats.memory_percent }}%"></div>
                                    </div>
                                </td>
                                <td class="stat-detail">{{ "%.1f"|format(system_stats.memory_used / 1024**3) }} GB used / {{ "%.1f"|format(system_stats.memory_total / 1024**3) }} GB total</td>
                            </tr>
                            {% for disk in system_stats.disk_usage[:2] %}
                            <tr>
                                <td class="stat-label">Disk {{ disk.mountpoint }}</td>
                                <td class="stat-value">{{ "%.1f"|format(disk.percent) }}%</td>
                                <td class="stat-bar">
                                    <div class="metric-bar">
                                        <div class="metric-bar-fill {% if disk.percent > 80 %}error{% elif disk.percent > 60 %}warning{% endif %}"
                                             style="width: {{ disk.percent }}%"></div>
                                    </div>
                                </td>
                                <td class="stat-detail">{{ "%.1f"|format(disk.used / 1024**3) }} GB used / {{ "%.1f"|format(disk.total / 1024**3) }} GB total</td>
                            </tr>
                            {% endfor %}
                        </table>
                    </div>
                </div>
            </div>

            <!-- Top Processes -->
            <div class="panel">
                <div class="panel-header">Top Processes (CPU)</div>
                <div class="panel-content">
                    <table class="process-list">
                        {% for proc in system_stats.top_processes[:8] %}
                        <tr>
                            <td style="width: 40px;">{{ proc.pid }}</td>
                            <td>{{ proc.name[:30] }}</td>
                            <td style="width: 50px; text-align: right;">{{ "%.1f"|format(proc.cpu_percent) }}%</td>
                            <td style="width: 50px; text-align: right;">{{ "%.1f"|format(proc.memory_percent) }}%</td>
                        </tr>
                        {% endfor %}
                    </table>
                </div>
            </div>

            <!-- Network Interfaces -->
            <div class="panel">
                <div class="panel-header">Network</div>
                <div class="panel-content">
                    <table class="process-list">
                        {% for iface, stats in system_stats.network_io.items() %}
                        <tr>
                            <td><code>{{ iface }}</code></td>
                            <td class="text-subtle">↓ {{ "%.1f"|format(stats.bytes_recv / 1024**3) }} GB</td>
                            <td class="text-subtle">↑ {{ "%.1f"|format(stats.bytes_sent / 1024**3) }} GB</td>
                            <td class="text-subtle">err: {{ stats.errors_in + stats.errors_out }}</td>
                        </tr>
                        {% endfor %}
                    </table>
                </div>
            </div>
            </div>
        </div>

        <!-- Python Agent Tab -->
        <div class="tab-content" x-show="currentTab === 'agent'">
            <div class="panel agent-panel-fullwidth">
            <div class="panel-header">
                <span>Python Agent</span>
                <button class="btn" onclick="clearHistory()">Clear History</button>
            </div>
            <div class="agent-history" id="agent-history">
                <div class="text-subtle" style="font-size: 11px; margin-bottom: 12px;">
                    Interactive Python environment. Type code and press Ctrl+Enter to execute.<br>
                    Namespace persists between executions. Try: help_agent(), list_vars()
                </div>
            </div>
            <div class="agent-input-area">
                <textarea
                    id="code-input"
                    class="code-input"
                    placeholder=">>> import os; os.getcwd()"
                    onkeydown="handleKeyPress(event)"></textarea>
                <div class="flex gap-sm">
                    <button class="btn btn-primary" onclick="executeCode()">Execute (Ctrl+Enter)</button>
                    <button class="btn" onclick="document.getElementById('code-input').value = ''">Clear</button>
                </div>
            </div>
        </div>
    </div>
    </div>

    <script>
        // Auto-update metrics timestamp
        setInterval(() => {
            const now = new Date();
            document.getElementById('metrics-time').textContent = now.toTimeString().split(' ')[0];
        }, 1000);

        // Python agent execution
        async function executeCode() {
            const code = document.getElementById('code-input').value.trim();
            if (!code) return;

            const response = await fetch('/api/agent/execute', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({code})
            });

            const result = await response.json();
            appendToHistory(result);
            document.getElementById('code-input').value = '';
            loadHistory();
        }

        function appendToHistory(result) {
            const history = document.getElementById('agent-history');
            const cell = document.createElement('div');
            cell.className = `agent-cell ${result.success ? 'success' : 'error'}`;

            let html = `<div class="agent-input">>>> ${escapeHtml(result.code)}</div>`;

            if (result.output) {
                html += `<div class="agent-output">${escapeHtml(result.output)}</div>`;
            }
            if (result.stdout) {
                html += `<div class="agent-output">${escapeHtml(result.stdout)}</div>`;
            }
            if (result.error) {
                html += `<div class="agent-error">${escapeHtml(result.error.type)}: ${escapeHtml(result.error.message)}</div>`;
            }

            cell.innerHTML = html;
            history.appendChild(cell);
            history.scrollTop = history.scrollHeight;
        }

        async function loadHistory() {
            const response = await fetch('/api/agent/history');
            const history = await response.json();
            const container = document.getElementById('agent-history');
            container.innerHTML = `<div class="text-subtle" style="font-size: 11px; margin-bottom: 12px;">
                Interactive Python environment. Type code and press Ctrl+Enter to execute.<br>
                Namespace persists between executions. Try: help_agent(), list_vars()
            </div>`;

            history.forEach(result => appendToHistory(result));
        }

        async function clearHistory() {
            await fetch('/api/agent/history', {method: 'DELETE'});
            loadHistory();
        }

        function handleKeyPress(event) {
            if (event.ctrlKey && event.key === 'Enter') {
                event.preventDefault();
                executeCode();
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Load history on page load
        loadHistory();

        // Table sorting functionality
        let sortDirection = {};
        document.querySelectorAll('.sortable').forEach(header => {
            header.addEventListener('click', () => {
                const sortKey = header.dataset.sort;
                const table = document.getElementById('container-table');
                const tbody = table.querySelector('tbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));

                // Toggle sort direction
                sortDirection[sortKey] = !sortDirection[sortKey];
                const ascending = sortDirection[sortKey];

                // Sort rows
                rows.sort((a, b) => {
                    let aVal = a.dataset[sortKey] || '';
                    let bVal = b.dataset[sortKey] || '';

                    // Convert to numbers if possible
                    const aNum = parseFloat(aVal);
                    const bNum = parseFloat(bVal);
                    if (!isNaN(aNum) && !isNaN(bNum)) {
                        return ascending ? aNum - bNum : bNum - aNum;
                    }

                    // String comparison
                    return ascending ?
                        aVal.localeCompare(bVal) :
                        bVal.localeCompare(aVal);
                });

                // Update DOM
                rows.forEach(row => tbody.appendChild(row));

                // Update sort indicators
                document.querySelectorAll('.sortable').forEach(h => {
                    h.classList.remove('sort-asc', 'sort-desc');
                });
                header.classList.add(ascending ? 'sort-asc' : 'sort-desc');
            });
        });
    </script>
</body>
</html>
